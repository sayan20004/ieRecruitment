@model ieRecruitment.Models.OtherDetailsViewModel
@{
    ViewData["Title"] = "Other Details & References";
    Layout = "~/Views/Shared/_RecruitmentFormLayout.cshtml";
}

@section PageStyles {
    <style>
        .scroll-body {
            max-height: calc(100vh - 360px);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
            -webkit-overflow-scrolling: touch;
        }

        /* Custom Scrollbar */
        .scroll-body::-webkit-scrollbar {
            width: 6px;
        }

        .scroll-body::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .scroll-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
            transition: background 0.2s ease;
        }

        .scroll-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Card Enhancements */
        .card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* Form Controls */
        .form-control,
        .form-select {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.625rem 0.875rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.15);
            background: white;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Radio Button Groups */
        .radio-group {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 0;
            transition: color 0.2s ease;
        }

        .radio-group label:hover {
            color: #3b82f6;
        }

        .form-check-input {
            cursor: pointer;
            width: 1.25rem;
            height: 1.25rem;
        }

        .form-check-input:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }

        /* Table Styles */
        .table {
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #0c4a6e;
            color: white;
        }

        .table thead th {
            font-weight: 600;
            border: none;
            padding: 0.875rem;
            text-transform: uppercase;
            font-size: 0.813rem;
            letter-spacing: 0.5px;
        }

        .table tbody tr:hover {
            background-color: #f8fafc;
        }

        .table tbody td {
            vertical-align: middle;
            padding: 0.875rem;
            border-color: #e2e8f0;
        }

        /* Button Styles */
        .btn {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: #3b82f6;
            border: none;
        }

        /* Section Animations */
        .section-content {
            animation: fadeIn 0.3s ease;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Form Label */
        .form-label {
            font-weight: 500;
            color: #334155;
            margin-bottom: 0.5rem;
        }

        /* Checkbox with text */
        .text-muted {
            font-size: 0.875rem;
        }

        .text-muted input[type="checkbox"] {
            margin-right: 0.375rem;
            cursor: pointer;
        }

        /* Alert/Info text */
        .text-muted.small {
            color: #64748b;
            font-size: 0.875rem;
        }

        /* Mobile Responsive */
        @@media (max-width: 768px) {
            .scroll-body {
                max-height: calc(100vh - 300px);
            }

            .btn-group {
                flex-direction: column;
                width: 100%;
            }

            .btn-group .btn {
                width: 100%;
                margin: 0 0 0.5rem 0 !important;
            }

            .radio-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .table {
                font-size: 0.813rem;
            }

            .table thead th,
            .table tbody td {
                padding: 0.625rem 0.5rem;
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
}

<div class="card p-3">
    <!-- Header with toggle -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h6 id="sectionTitle" class="fw-bold text-primary mb-0">Other Details</h6>
        <div class="btn-group" role="group" aria-label="Section toggle">
            <input type="radio" class="btn-check" name="sectionToggle" id="btnOther" checked>
            <label class="btn btn-outline-secondary tab-toggle-btn me-2" for="btnOther">Other Details</label>
            
            <input type="radio" class="btn-check" name="sectionToggle" id="btnRefs">
            <label class="btn btn-outline-secondary tab-toggle-btn" for="btnRefs">References</label>
        </div>
    </div>
    
    <div class="scroll-body">
        <form asp-action="Index" asp-controller="OtherDetails" method="post" id="otherDetailsForm">
            <!-- Hidden field for References JSON -->
            <input type="hidden" asp-for="ReferencesJSON" id="referencesJSON" />
            
            <!-- Other Details Section -->
            <div id="otherDetailsSection" class="section-content">
                <div class="card mb-3">
                    <div class="card-body">
                        
                        <!-- Why Suitable -->
                        <div class="mb-3">
                            <label asp-for="WhySuitable" class="form-label"></label>
                            <textarea asp-for="WhySuitable" class="form-control" rows="4" maxlength="2000"></textarea>
                            <span asp-validation-for="WhySuitable" class="text-danger small"></span>
                        </div>
                        
                        <!-- Aadhaar / PAN / Referrer -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="Referrer" class="form-label"></label>
                                <select asp-for="Referrer" class="form-select">
                                    <option value="">Select…</option>
                                    <option value="Employee">Employee</option>
                                    <option value="Friend">Friend</option>
                                    <option value="Job Portal">Job Portal</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Other">Other</option>
                                </select>
                                <span asp-validation-for="Referrer" class="text-danger small"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="AadhaarNo" class="form-label"></label>
                                <input asp-for="AadhaarNo" type="text" class="form-control" placeholder="XXXX-XXXX-XXXX" maxlength="14">
                                <span asp-validation-for="AadhaarNo" class="text-danger small"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="PanNo" class="form-label"></label>
                                <input asp-for="PanNo" type="text" class="form-control" placeholder="ABCDE1234F" maxlength="10" style="text-transform: uppercase;">
                                <span asp-validation-for="PanNo" class="text-danger small"></span>
                            </div>
                        </div>
                        
                        <!-- UAN / ESIC -->
                        <div class="row g-3 mt-1">
                            <div class="col-md-6">
                                <label asp-for="UanNo" class="form-label"></label>
                                <input asp-for="UanNo" type="text" class="form-control" id="uanInput">
                                <small class="text-muted">
                                    <input asp-for="NoUan" type="checkbox" id="noUanCheckbox"> 
                                    <label asp-for="NoUan"></label>
                                </small>
                                <span asp-validation-for="UanNo" class="text-danger small d-block"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EsicNo" class="form-label"></label>
                                <input asp-for="EsicNo" type="text" class="form-control" id="esicInput">
                                <small class="text-muted">
                                    <input asp-for="NoEsic" type="checkbox" id="noEsicCheckbox"> 
                                    <label asp-for="NoEsic"></label>
                                </small>
                                <span asp-validation-for="EsicNo" class="text-danger small d-block"></span>
                            </div>
                        </div>
                        
                        <!-- Yes/No Questions -->
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label asp-for="InterviewedBefore" class="form-label d-block"></label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="InterviewedBefore" value="true" class="form-check-input" 
                                               @(Model?.InterviewedBefore == true ? "checked" : "")> Yes
                                    </label>
                                    <label>
                                        <input type="radio" name="InterviewedBefore" value="false" class="form-check-input"
                                               @(Model?.InterviewedBefore == false ? "checked" : "")> No
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="RelativesWorking" class="form-label d-block"></label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="RelativesWorking" value="true" class="form-check-input"
                                               @(Model?.RelativesWorking == true ? "checked" : "")> Yes
                                    </label>
                                    <label>
                                        <input type="radio" name="RelativesWorking" value="false" class="form-check-input"
                                               @(Model?.RelativesWorking == false ? "checked" : "")> No
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="HasDisability" class="form-label d-block"></label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="HasDisability" value="true" class="form-check-input"
                                               @(Model?.HasDisability == true ? "checked" : "")> Yes
                                    </label>
                                    <label>
                                        <input type="radio" name="HasDisability" value="false" class="form-check-input"
                                               @(Model?.HasDisability == false ? "checked" : "")> No
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EverDismissed" class="form-label d-block"></label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="EverDismissed" value="true" class="form-check-input"
                                               @(Model?.EverDismissed == true ? "checked" : "")> Yes
                                    </label>
                                    <label>
                                        <input type="radio" name="EverDismissed" value="false" class="form-check-input"
                                               @(Model?.EverDismissed == false ? "checked" : "")> No
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EverConvicted" class="form-label d-block"></label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="EverConvicted" value="true" class="form-check-input"
                                               @(Model?.EverConvicted == true ? "checked" : "")> Yes
                                    </label>
                                    <label>
                                        <input type="radio" name="EverConvicted" value="false" class="form-check-input"
                                               @(Model?.EverConvicted == false ? "checked" : "")> No
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="JoiningTimeDays" class="form-label"></label>
                                <input asp-for="JoiningTimeDays" type="number" class="form-control" placeholder="e.g., 7" min="1" max="365">
                                <span asp-validation-for="JoiningTimeDays" class="text-danger small"></span>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- References Section -->
            <div id="referencesSection" class="section-content" style="display:none;">
                <div class="card">
                    <div class="card-body">
                        <p class="text-muted small mb-3">Please mention name & address of two references (other than relatives).</p>
                        
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" id="refName">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Relation</label>
                                <input type="text" class="form-control" id="refRelation">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control" id="refAddress">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Phone No.</label>
                                <input type="tel" class="form-control" id="refPhone" placeholder="(123) 456-7890">
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addReferenceBtn">
                                <i class="bi bi-plus-circle me-1"></i> Add Reference
                            </button>
                        </div>
                        
                        <!-- Reference table -->
                        <div class="table-responsive mt-3" id="referenceTableContainer" style="display:none;">
                            <table class="table table-bordered table-sm mb-0 align-middle">
                                <thead class="text-center">
                                    <tr>
                                        <th>Name</th>
                                        <th>Relation</th>
                                        <th>Address</th>
                                        <th>Phone No.</th>
                                        <th style="width:120px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="text-center" id="referenceTableBody">
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Empty state -->
                        <div id="emptyState" class="empty-state">
                            <i class="bi bi-people"></i>
                            <p class="mb-0">No references added yet</p>
                        </div>
                        
                    </div>
                </div>
            </div>
            
        </form>
    </div>
</div>

@section PageScripts {
    <script>
        (() => {
            'use strict';
            
            // Helper functions
            const $ = (sel, root = document) => root.querySelector(sel);
            const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
            
            // Section toggle functionality
            const btnOther = $('#btnOther');
            const btnRefs = $('#btnRefs');
            const otherDetailsSection = $('#otherDetailsSection');
            const referencesSection = $('#referencesSection');
            const sectionTitle = $('#sectionTitle');
            
            const showSection = (section) => {
                if (section === 'other') {
                    otherDetailsSection.style.display = 'block';
                    referencesSection.style.display = 'none';
                    sectionTitle.textContent = 'Other Details';
                } else {
                    otherDetailsSection.style.display = 'none';
                    referencesSection.style.display = 'block';
                    sectionTitle.textContent = 'References';
                }
            };
            
            btnOther.addEventListener('change', () => showSection('other'));
            btnRefs.addEventListener('change', () => showSection('references'));
            
            // UAN/ESIC checkbox logic
            const uanInput = $('#uanInput');
            const noUanCheckbox = $('#noUanCheckbox');
            const esicInput = $('#esicInput');
            const noEsicCheckbox = $('#noEsicCheckbox');
            
            noUanCheckbox?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    uanInput.value = '';
                    uanInput.disabled = true;
                } else {
                    uanInput.disabled = false;
                }
            });
            
            noEsicCheckbox?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    esicInput.value = '';
                    esicInput.disabled = true;
                } else {
                    esicInput.disabled = false;
                }
            });
            
            // Initialize disabled state if checkboxes are already checked
            if (noUanCheckbox?.checked) {
                uanInput.disabled = true;
            }
            if (noEsicCheckbox?.checked) {
                esicInput.disabled = true;
            }
            
            // References management
            let references = [];
            const referencesJSON = $('#referencesJSON');
            const referenceTableBody = $('#referenceTableBody');
            const referenceTableContainer = $('#referenceTableContainer');
            const emptyState = $('#emptyState');
            const addReferenceBtn = $('#addReferenceBtn');
            
            // Load existing references from hidden field
            const loadReferences = () => {
                try {
                    const jsonValue = referencesJSON.value;
                    if (jsonValue && jsonValue.trim() !== '') {
                        references = JSON.parse(jsonValue);
                        renderReferences();
                    }
                } catch (e) {
                    console.error('Error parsing references JSON:', e);
                    references = [];
                }
            };
            
            // Save references to hidden field
            const saveReferences = () => {
                referencesJSON.value = JSON.stringify(references);
            };
            
            // Render references table
            const renderReferences = () => {
                if (references.length === 0) {
                    referenceTableContainer.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }
                
                referenceTableContainer.style.display = 'block';
                emptyState.style.display = 'none';
                
                referenceTableBody.innerHTML = references.map((ref, index) => `
                    <tr>
                        <td>${escapeHtml(ref.Name || '')}</td>
                        <td>${escapeHtml(ref.Relation || '')}</td>
                        <td>${escapeHtml(ref.Address || '')}</td>
                        <td>${escapeHtml(ref.PhoneNo || '')}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="editReference(${index})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteReference(${index})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            };
            
            // Escape HTML to prevent XSS
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            // Add reference
            let editingIndex = -1;
            addReferenceBtn?.addEventListener('click', () => {
                const name = $('#refName').value.trim();
                const relation = $('#refRelation').value.trim();
                const address = $('#refAddress').value.trim();
                const phone = $('#refPhone').value.trim();
                
                if (!name || !relation || !address || !phone) {
                    alert('Please fill in all reference fields');
                    return;
                }
                
                const reference = {
                    Name: name,
                    Relation: relation,
                    Address: address,
                    PhoneNo: phone
                };
                
                if (editingIndex >= 0) {
                    // Update existing reference
                    references[editingIndex] = reference;
                    editingIndex = -1;
                    addReferenceBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Add Reference';
                } else {
                    // Add new reference
                    references.push(reference);
                }
                
                saveReferences();
                renderReferences();
                
                // Clear form
                $('#refName').value = '';
                $('#refRelation').value = '';
                $('#refAddress').value = '';
                $('#refPhone').value = '';
            });
            
            // Edit reference
            window.editReference = (index) => {
                const ref = references[index];
                $('#refName').value = ref.Name || '';
                $('#refRelation').value = ref.Relation || '';
                $('#refAddress').value = ref.Address || '';
                $('#refPhone').value = ref.PhoneNo || '';
                
                editingIndex = index;
                addReferenceBtn.innerHTML = '<i class="bi bi-save me-1"></i> Update Reference';
                
                // Scroll to form
                $('#refName').focus();
            };
            
            // Delete reference
            window.deleteReference = (index) => {
                if (confirm('Are you sure you want to delete this reference?')) {
                    references.splice(index, 1);
                    saveReferences();
                    renderReferences();
                }
            };
            
            // Initialize
            loadReferences();

            // ── Auto-fill references from CV extraction ──
            if (window.__cvReferences && references.length === 0) {
                window.__cvReferences.forEach(ref => {
                    if (!ref.name) return;
                    references.push({
                        Name: ref.name || '',
                        Relation: ref.relation || '',
                        Address: ref.address || '',
                        PhoneNo: ref.phone || ''
                    });
                });
                if (references.length > 0) {
                    saveReferences();
                    renderReferences();
                    console.log('[CV Auto-Fill] References auto-filled:', references);
                }
                delete window.__cvReferences;
            }
            
            // Form validation enhancement
            const form = $('#otherDetailsForm');
            form?.addEventListener('submit', (e) => {
                // Ensure references are saved
                saveReferences();
            });

            // Connect footer buttons to form
            setTimeout(() => {
                const btnNext = document.getElementById('btnNext');
                const btnSave = document.getElementById('btnSave');

                if (btnNext && form) {
                    btnNext.addEventListener('click', (e) => {
                        e.preventDefault();
                        form.submit();
                    });
                }

                if (btnSave && form) {
                    btnSave.addEventListener('click', (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        fetch(form.action, {
                            method: 'POST',
                            body: formData
                        }).then(() => {
                            alert('Other details saved successfully!');
                        }).catch(err => {
                            console.error('Save failed:', err);
                        });
                    });
                }
            }, 100);
            
        })();
    </script>
}
