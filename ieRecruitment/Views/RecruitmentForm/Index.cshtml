@model ieRecruitment.Models.RecruitmentFormViewModel
@{
    ViewData["Title"] = "Recruitment Form";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    
    <style>
        /* Font */
        @@font-face {
            font-family: 'Manrope';
            src: url('/fonts/Manrope-Medium.woff2') format('woff2'),
                 url('/fonts/Manrope-Medium.woff') format('woff');
            font-weight: 500; font-style: normal; font-display: swap;
        }

        /* Base */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            margin: 0; font-size: .85rem; background: #f8f9fa;
            font-family: 'Manrope', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        .text-primary { color: #0461A3 !important; }
        .form-control { font-size: 0.8rem !important; }
        .form-label { font-size: 0.8rem; font-weight: 600; }
        .form-select { font-size: 0.85rem; }
        .app-header, .app-header *, h1, h2, h3, h4, h5, h6, p, label, small, span, a, .btn { text-shadow: none !important; }

        /* Header */
        .app-header { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .portal-heading { color: #0c4a6e; font-size: 1.25rem; text-align: center; letter-spacing: 1px; margin: 0; }

        /* Main */
        main { min-height: calc(100vh - 80px); padding-top: 5rem; }

        /* Form Section */
        .form-section {
            position: relative; max-width: 600px;
            border: 1px solid #e6edf5; border-radius: 16px;
            background: radial-gradient(1200px 500px at -10% -40%, rgba(22,125,128,.06), transparent 60%),
                        radial-gradient(900px 420px at 120% -50%, rgba(4,97,163,.06), transparent 60%),
                        linear-gradient(180deg, #ffffff, #fbfdff);
            box-shadow: 0 10px 30px rgba(16,24,40,.06); overflow: hidden;
        }
        .fs-header {
            display: flex; align-items: flex-start; justify-content: space-between; gap: .75rem;
            padding: 14px 18px 6px; background: linear-gradient(180deg, #f9fbff, #f6fbfb);
            border-bottom: 1px solid #eef2f6;
        }
        .fs-title { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: .2px; color: #0461A3; }
        .fs-subtitle { margin: 2px 0 0; color: #6b7280; font-size: .85rem; }
        .fs-body { padding: 18px; padding-top: 10px; }

        /* Form Heading */
        .form-heading-custom { color: #0c4a6e; font-size: 1.75rem; font-weight: 600; }
        .sub-heading-custom { color: #64748b; font-size: 0.938rem; }

        /* Info Banner */
        .info-banner {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            border-left: 4px solid #3b82f6; padding: 1rem 1.25rem; border-radius: 8px;
        }
        .info-banner .label { font-weight: 600; color: #334155; }
        .info-banner .value { color: #3b82f6; font-weight: 600; }
        .candidate-note { color: #64748b; font-size: 0.813rem; }

        /* Form Elements */
        .form-label-weight-fixing { font-weight: 500; color: #334155; }
        .recruitment-btn-custom {
            background: linear-gradient(135deg, #0c4a6e 0%, #075985 100%);
            border: none; padding: 0.75rem 2rem; font-weight: 600;
            border-radius: 8px; width: 100%; color: white;
        }
        .recruitment-btn-custom:hover { background: linear-gradient(135deg, #075985 0%, #0c4a6e 100%); }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; inset: 0; background: rgba(255,255,255,.7);
            backdrop-filter: blur(2px); display: none !important;
            align-items: center; justify-content: center; z-index: 2000;
        }

        /* ── CV Extraction Modal ── */
        .extraction-modal-backdrop {
            position: fixed; inset: 0; z-index: 3000;
            background: rgba(15, 23, 42, .55);
            backdrop-filter: blur(6px);
            display: none; align-items: center; justify-content: center;
        }
        .extraction-modal-backdrop.show { display: flex; }
        .extraction-card {
            background: #fff; border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0,0,0,.18);
            padding: 2.5rem 2rem 2rem; text-align: center;
            max-width: 380px; width: 90%; position: relative;
            animation: modalSlideUp .4s cubic-bezier(.16,1,.3,1);
        }
        @@keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(30px) scale(.96); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Animated scanner ring */
        .scanner-ring {
            width: 90px; height: 90px; margin: 0 auto 1.25rem;
            position: relative;
        }
        .scanner-ring .ring {
            position: absolute; inset: 0; border-radius: 50%;
            border: 3.5px solid transparent;
            border-top-color: #0461A3; border-right-color: #0461A3;
            animation: ringRotate 1.1s linear infinite;
        }
        .scanner-ring .ring:nth-child(2) {
            inset: 8px; border-top-color: #06b6d4; border-right-color: #06b6d4;
            animation-duration: 1.6s; animation-direction: reverse;
        }
        .scanner-ring .ring-icon {
            position: absolute; inset: 0; display: flex;
            align-items: center; justify-content: center;
            font-size: 1.8rem; color: #0461A3;
        }
        @@keyframes ringRotate { to { transform: rotate(360deg); } }

        /* Progress bar inside modal */
        .extraction-progress {
            height: 5px; border-radius: 3px;
            background: #e2e8f0; margin: 1rem 0 .75rem; overflow: hidden;
        }
        .extraction-progress .bar {
            height: 100%; border-radius: 3px; width: 0%;
            background: linear-gradient(90deg, #0461A3, #06b6d4);
            transition: width .4s ease;
        }
        .extraction-steps {
            list-style: none; padding: 0; margin: 0; text-align: left;
        }
        .extraction-steps li {
            font-size: .8rem; color: #94a3b8; padding: 3px 0;
            display: flex; align-items: center; gap: 6px;
            transition: color .3s;
        }
        .extraction-steps li.active { color: #0461A3; font-weight: 600; }
        .extraction-steps li.done   { color: #10b981; }
        .extraction-steps li .step-icon { width: 16px; text-align: center; }

        /* Responsive */
        @@media (max-width: 992px) { .form-section { margin-top: 1rem; } }
        @@media (max-width: 991px) { main { padding-top: 6rem; } }
        @@media (max-width: 576px) { .form-section { margin-top: 3rem; } }
    </style>
</head>

<body>
    <!-- CV Extraction Modal -->
    <div id="extractionModal" class="extraction-modal-backdrop">
        <div class="extraction-card">
            <div class="scanner-ring">
                <div class="ring"></div>
                <div class="ring"></div>
                <div class="ring-icon"><i class="bi bi-file-earmark-text"></i></div>
            </div>
            <h5 class="fw-bold text-dark mb-1" style="font-size:1.05rem;">Extracting CV Data</h5>
            <p class="text-muted mb-2" style="font-size:.82rem;" id="extractionSubtext">Our AI is reading your resume…</p>
            <div class="extraction-progress">
                <div class="bar" id="extractionBar"></div>
            </div>
            <ul class="extraction-steps" id="extractionSteps">
                <li data-step="upload"><span class="step-icon"><i class="bi bi-cloud-upload"></i></span> Uploading document</li>
                <li data-step="parse"><span class="step-icon"><i class="bi bi-cpu"></i></span> Parsing CV content</li>
                <li data-step="extract"><span class="step-icon"><i class="bi bi-magic"></i></span> Extracting information with AI</li>
                <li data-step="done"><span class="step-icon"><i class="bi bi-check-circle"></i></span> Mapping to form fields</li>
            </ul>
        </div>
    </div>

    <div id="app">
        <!-- Fixed Header -->
        <header class="app-header fixed-top bg-white py-2 ps-2" role="banner">
            <div class="container-fluid">
                <div class="row align-items-center justify-content-center">
                    <!-- Logo -->
                    <div class="col-auto d-flex align-items-center justify-content-center mb-2 mb-sm-0 pe-2">
                        <img src="~/img/logo1.png" alt="Mendine Logo" class="img-fluid" style="max-height: 38px;">
                    </div>

                    <!-- Header Text -->
                    <div class="col d-flex align-items-center justify-content-start">
                        <h2 class="mb-0 fw-semibold portal-heading">RECRUITMENT PORTAL</h2>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main id="content" class="container-fluid">
            <div class="row">
                <!-- Left Illustration -->
                <div class="col-lg-6">
                    <div class="d-none d-lg-flex align-items-center justify-content-center h-100">
                        <img src="~/img/mendian-recruitment-portal-img-02.png" alt="Recruitment Illustration" class="img-fluid" loading="lazy">
                    </div>
                </div>

                <!-- Form Section -->
                <div class="col-lg-6 col-md-12 d-flex align-items-center justify-content-center mt-0 mt-md-3 mt-sm-2">
                    <div class="form-section w-100 mx-0 mx-md-4 mb-0 mb-md-3 mb-sm-2">
                        <!-- Header -->
                        <div class="fs-header mb-4">
                            <h2 class="fs-title form-heading-custom">Recruitment Form</h2>
                            <p class="fs-subtitle sub-heading-custom">Use the form below to fill out your application form</p>
                        </div>

                        <!-- Body -->
                        <div class="fs-body">
                            <!-- Candidate Code -->
                            <div class="info-banner mb-4">
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <span class="label">Candidate Code:</span>
                                    <span class="value">@Model.CandidateCode</span>
                                </div>
                                <small class="candidate-note">(For Office Use Only)</small>
                            </div>

                            <form asp-action="Index" asp-controller="RecruitmentForm" method="post" enctype="multipart/form-data" novalidate>
                                @Html.AntiForgeryToken()
                                
                                <!-- Name Fields -->
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label asp-for="FirstName" class="form-label form-label-weight-fixing"></label>
                                        <input asp-for="FirstName" type="text" class="form-control" placeholder="Enter First Name" autocomplete="given-name">
                                        <span asp-validation-for="FirstName" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <label asp-for="MiddleName" class="form-label form-label-weight-fixing"></label>
                                        <input asp-for="MiddleName" type="text" class="form-control" placeholder="Enter Middle Name" autocomplete="additional-name">
                                        <span asp-validation-for="MiddleName" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <label asp-for="LastName" class="form-label form-label-weight-fixing"></label>
                                        <input asp-for="LastName" type="text" class="form-control" placeholder="Enter Last Name" autocomplete="family-name">
                                        <span asp-validation-for="LastName" class="text-danger small"></span>
                                    </div>
                                </div>

                                <!-- Post Applied -->
                                <div class="mb-3">
                                    <h5 class="text-primary mb-2">Post Applying For :</h5>
                                    <div class="info-banner">
                                        <span class="label">Position</span>
                                        <span class="value">@Model.Position</span>
                                    </div>
                                </div>

                                <!-- File Upload -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label form-label-weight-fixing">
                                            Please Upload your CV <span class="text-danger">*</span>
                                        </label>
                                        <input asp-for="CVUpload" type="file" class="form-control" accept=".pdf,.doc,.docx" aria-describedby="cvHelp">
                                        <small id="cvHelp" class="text-muted">(pdf/doc/docx only)</small>
                                        <span asp-validation-for="CVUpload" class="text-danger small d-block"></span>
                                        <!-- Extraction status badge -->
                                        <div id="extractionStatus" class="mt-2" style="display:none;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label form-label-weight-fixing">
                                            Upload Recent Photograph <span class="text-danger">*</span>
                                        </label>
                                        <input asp-for="PhotoUpload" type="file" class="form-control" accept=".jpg,.jpeg,.png" aria-describedby="photoHelp">
                                        <small id="photoHelp" class="text-muted">(jpg/jpeg/png, max 2MB)</small>
                                        <span asp-validation-for="PhotoUpload" class="text-danger small d-block"></span>
                                    </div>
                                </div>

                                <!-- Submit -->
                                <button type="submit" class="btn btn-primary recruitment-btn-custom">
                                    Save &amp; Proceed to Next Section
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Chatbot -->
        @await Html.PartialAsync("_ChatbotWidget")
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery & Validation -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@4.0.0/dist/jquery.validate.unobtrusive.min.js"></script>

    <!-- Toast container for notifications -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2050;">
        <div id="cvToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="cvToastBody"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script>
        (() => {
            'use strict';

            const cvInput = document.getElementById('CVUpload');
            const statusEl = document.getElementById('extractionStatus');

            // ── Extraction Modal helpers ──
            const modal     = document.getElementById('extractionModal');
            const bar       = document.getElementById('extractionBar');
            const subtext   = document.getElementById('extractionSubtext');
            const stepEls   = document.querySelectorAll('#extractionSteps li');

            function showModal() {
                resetSteps();
                modal.classList.add('show');
            }
            function hideModal() {
                modal.classList.remove('show');
            }
            function resetSteps() {
                bar.style.width = '0%';
                subtext.textContent = 'Our AI is reading your resume…';
                stepEls.forEach(li => { li.className = ''; });
            }
            function activateStep(name, pct, text) {
                stepEls.forEach(li => {
                    const s = li.dataset.step;
                    if (s === name) {
                        li.className = 'active';
                        li.querySelector('.step-icon').innerHTML = '<i class="bi bi-arrow-repeat spin"></i>';
                    } else if (getPriority(s) < getPriority(name)) {
                        li.className = 'done';
                        li.querySelector('.step-icon').innerHTML = '<i class="bi bi-check-lg"></i>';
                    }
                });
                bar.style.width = pct + '%';
                if (text) subtext.textContent = text;
            }
            function completeAllSteps() {
                stepEls.forEach(li => {
                    li.className = 'done';
                    li.querySelector('.step-icon').innerHTML = '<i class="bi bi-check-lg"></i>';
                });
                bar.style.width = '100%';
                subtext.textContent = 'Extraction complete!';
            }
            function getPriority(step) {
                return { upload: 0, parse: 1, extract: 2, done: 3 }[step] ?? -1;
            }

            // Toast helper
            function showToast(message, type) {
                const toastEl = document.getElementById('cvToast');
                const bodyEl = document.getElementById('cvToastBody');
                if (!toastEl || !bodyEl) return;
                toastEl.className = 'toast align-items-center border-0 text-white bg-' +
                    (type === 'success' ? 'success' : type === 'danger' ? 'danger' : 'warning');
                bodyEl.textContent = message;
                const toast = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 5000 });
                toast.show();
            }

            // Show extraction status badge
            function setStatus(html, show) {
                if (!statusEl) return;
                statusEl.innerHTML = html;
                statusEl.style.display = show ? 'block' : 'none';
            }

            // Fill a form field by ID
            function fill(id, value) {
                if (!value) return;
                const el = document.getElementById(id);
                if (el) {
                    el.value = value;
                    el.dispatchEvent(new Event('input', { bubbles: true }));
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }

            if (cvInput) {
                cvInput.addEventListener('change', async function () {
                    const file = this.files?.[0];
                    if (!file) return;

                    const ext = file.name.split('.').pop().toLowerCase();
                    if (!['pdf', 'doc', 'docx'].includes(ext)) return;

                    // ── Show modal & start step animation ──
                    showModal();
                    activateStep('upload', 10, 'Uploading your document…');

                    setStatus(
                        '<span class="badge bg-info text-dark"><i class="bi bi-arrow-repeat spin me-1"></i>Extracting CV data with AI…</span>',
                        true
                    );

                    const formData = new FormData();
                    formData.append('cvFile', file);

                    // Simulate step progression while waiting for API
                    const stepTimers = [
                        setTimeout(() => activateStep('parse',   30, 'Parsing CV content…'),    800),
                        setTimeout(() => activateStep('extract', 55, 'AI is extracting your details…'), 2200),
                        setTimeout(() => { bar.style.width = '75%'; }, 4000),
                    ];

                    try {
                        const resp = await fetch('/RecruitmentForm/ExtractCv', {
                            method: 'POST',
                            body: formData
                        });
                        const result = await resp.json();

                        // Clear pending timers
                        stepTimers.forEach(clearTimeout);

                        if (result.success && result.data) {
                            // Animate final steps
                            activateStep('done', 90, 'Mapping to form fields…');

                            // Store for other form pages
                            localStorage.setItem('cvExtractedData', JSON.stringify(result.data));

                            // Fill name fields on current page
                            fill('FirstName', result.data.firstName);
                            fill('MiddleName', result.data.middleName);
                            fill('LastName', result.data.lastName);

                            // Count extracted fields
                            let count = 0;
                            const d = result.data;
                            if (d.firstName) count++;
                            if (d.lastName) count++;
                            if (d.professionalSummary) count++;
                            if (d.education) count++;
                            if (d.workExperience?.experiences?.length) count += d.workExperience.experiences.length;
                            if (d.skills?.length) count += d.skills.length;
                            if (d.languages?.length) count += d.languages.length;

                            // Complete all steps
                            setTimeout(() => {
                                completeAllSteps();
                                setStatus(
                                    `<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>CV extracted – ${count}+ fields found. Forms will be auto-filled.</span>`,
                                    true
                                );
                                showToast('CV data extracted successfully! Forms will be auto-filled as you proceed.', 'success');
                                // Hide modal after a brief moment
                                setTimeout(hideModal, 1200);
                            }, 400);

                        } else {
                            stepTimers.forEach(clearTimeout);
                            setStatus(
                                `<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>${result.message || 'Extraction failed'}</span>`,
                                true
                            );
                            showToast(result.message || 'Could not extract CV data. You can fill forms manually.', 'warning');
                            hideModal();
                        }
                    } catch (err) {
                        console.error('CV extraction error:', err);
                        stepTimers.forEach(clearTimeout);
                        setStatus(
                            '<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Extraction failed</span>',
                            true
                        );
                        showToast('CV extraction failed. You can fill in forms manually.', 'danger');
                        hideModal();
                    }
                });
            }
        })();
    </script>

    <style>
        .spin { display: inline-block; animation: spin 1s linear infinite; }
        @@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</body>
</html>
